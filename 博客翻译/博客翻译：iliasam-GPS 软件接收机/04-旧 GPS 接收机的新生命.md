> 翻译自俄语文章：https://habr.com/ru/articles/765402/，Deepl 机翻再简单修改

# 旧 GPS 接收机的新生命

本文主要介绍 GPS 接收机的理论，我将不再深入探讨公式和细微差别，而是对理论的应用进行实际描述。

[TOC]

## 一、卫星发射的信号

我想大多数读者已经知道，全球定位系统的坐标确定方法是基于测量接收机天线接收导航卫星同步信号的时刻。接收机知道卫星的坐标后，就可以利用测量到的延迟时间计算出与卫星的距离，进而计算出自己在太空中的位置。但卫星到底发射什么呢？

在 GPS 系统中，最广为人知的信号是在 L1 频率（1575.42 兆赫）上传输的 C/A 代码信号。所有 GPS 卫星的 L1 频率相同。C/A 是民用信号，P(Y)码也在同一频率上传输，只能由军方解码。从民用接收机的角度来看，P(Y)-代码只是噪音，可以忽略它的存在。

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240310190408358.png" alt="image-20240310190408358" style="zoom: 67%;" />

这里最有趣的是 C/A 代码本身，它是以 1.023 Mbit/s 的速率形成的比特流。该数据流是一种类似伪随机噪声的编码（PRN），它是根据每个卫星独有的特殊公式生成的。

数据流由 1023 个比特（称为码片/位）组成，这意味着每 1023 个码片（1 毫秒）重复一次数据。该数据流也被称为测距码，因为该代码的重复时间是以卫星上的 UTC 时间为参照的。

卫星还生成导航数据流，速率为每秒 50 比特。该数据流包含当前时间的完整信息、卫星轨道的星历（ephimerides）以及其他一些信息。

导航数据通过 XOR 运算与 C/A 码相乘，然后利用生成的数据流控制 L1 载波频率调制。使用的调制方式是 BPSK（二进制相移键控），即当数据的二进制值发生变化时，生成的载波频率正弦波相位会发生 180 度的变化，实际上是倒相。

请注意，上述所有信号的相位都是同步的，例如，导航数据的位变化与 C/A 代码的周期有明显的联系。

## 二、接收卫星信号进行进一步处理

如何在个人电脑上接收和处理 GPS 信号？首先想到的是使用 SDR 接收器。

接收机的任务是放大接收到的信号，将其传输到一个较低的频率，进行数字化处理，然后传输到个人电脑。要接收 GPS 信号，接收器必须能够接收 1575 MHz 频率的信号，并具有 2 MHz 以上的带宽。

即使是 [RTL-SDR](https://www.rtl-sdr.com/rtl-sdr-tutorial-gps-decoding-plotting/) 这样简单的接收器也足够了。下面是如何使用这种接收器接收 GPS 的详细说明。

我尝试重复所述指令，并取得了成功。这个实验是我写这篇文章的基础，接下来我将谈谈这个指令中提到的开源程序 "GNSS-SDRLIB"。

重复指令时应注意什么？

* 我使用的是一台相当老旧的 RTL-SDR 接收器，没有经过任何业余无线电改进。正如手册中提到的，在 1575 MHz 频率下工作时，调谐器芯片会很快过热（30-50 秒），信号接收会受到干扰。因此，我不得不将电路板从接收机中取出，用风扇吹，这样接收机才能正常工作很长时间。
* 重要的是在 "GNSS-SDRLIB "设置中设置 "时钟误差 "值 - 接收机石英谐振器频率的偏差，单位为 ppm（应事先测量）。对于 GPS 数据处理来说，了解石英的准确频率非常重要，如果误差过大，算法将根本无法检测到 GPS 信号。
* 最好不要选择程序中（右侧窗口中）的所有卫星，而只选择接收机上方实际存在的卫星。该程序对 CPU 的要求很高。

以前，在廉价的全球导航卫星系统接收器普及之前，爱好者们使用专门的全球导航卫星系统接收器。例如 [SiGe GN3S Sampler v3](https://www.sparkfun.com/products/retired/10981)：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240310190941718.png" alt="image-20240310190941718" style="zoom:67%;" />

这类接收机的优点包括：能够同时接收两个遥远波段的信号、可以同时同步接收来自两根天线的信号、配备精确的石英振荡器 TCXO 和专用硬件带通滤波器；因此，即使在现在的某些情况下，这类接收机也没有失去其意义。

## 三、对一台老式 GPS 接收机的调查

现在终于可以使用标题中提到的接收器了。很久以前，我就有一台 Globalsat BT-318 GPS 接收机。

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240310191055856.png" alt="image-20240310191055856" style="zoom:67%;" />

这是同类产品中的典型代表--带蓝牙接口的 GPS 接收器。接收器内置电池，专为连接没有内置 GPS 接收器的掌上电脑而设计。它于 2004 年上市，距今已有 19 年。它采用 SiRF StarIIe 芯片组。

有一天，这个接收器再次吸引了我的注意，我想，"我能否用它来获取 "原始 "GPS 数据并在 PC 上进行处理呢？

当时我已经有了使用 RTL-SDR 的经验，也知道 GNSS-SDRLIB 可以与专门的 GNSS 接收机配合使用。就在那时，我决定对接收机进行更深入的研究。

该芯片组的结构图：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240310191146323.png" alt="image-20240310191146323" style="zoom: 67%;" />

您可以看到，接收器由两个主要芯片组成--GRF2i/LP 和 GSP2e/LP。第一个芯片实际上就是上文提到的 GNSS 射频前端，第二个芯片则是接收器的 "大脑"，它负责处理接收到的数字化信号，并通过 UART 以 NMEA 数据包的形式输出结果。如果我没弄错的话，将接收器分成两个芯片是必要的，因为它们采用不同的生产工艺制造，这样就可以将接收器的模拟部分与数字部分可靠地分开。

从原理图中可以看出，GRF2i/LP 芯片的数据是数字形式的，可以被截取并传输到 PC。

不幸的是，我没有拆卸接收器的好照片，所以只能用 [FCC.ID](https://fccid.io/RIDBT-318/Internal-Photos/Internal-Photos-414460.pdf) 上的照片来凑合了：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240310191320233.png" alt="image-20240310191320233" style="zoom: 80%;" />

右上方是 GRF2i/LP 芯片及其管道，包括 TCXO，右下方是 GSP2e/LP 芯片和闪存。它们被放置在一块独立的电路板上，实际上构成了一个 GPS 接收机模块。左侧是蓝牙模块。所有三个节点都有金属屏幕盖，不易拆卸。

遗憾的是，我找不到任何有关 GRF2i/LP 芯片的文档。但对于 GSP2e/LP，在 2000 年有这样一份文件：SiRF 应用说明 GSP2e 硬件实现 (APNT0012)。它提供了一些有关 GRF2i/LP 芯片运行的详细信息。

我还找到了这个[演示文稿](https://old.hotchips.org/wp-content/uploads/hc_archives/hc11/3_Tue/hc99.s7.3.Turetzky.pdf)，不幸的是，它让我更加困惑了。

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240310191429328.png" alt="image-20240310191429328" style="zoom: 50%;" />

事实上，带捆绑的芯片工作原理非常简单--我们给它输入一个高频信号，它将其放大（LNA）并传输到一个较低的频率（中频 - IF）~9.45 MHz，芯片内部接收到的信号再次被放大，并通过一个两位 ADC 进行数字化，数字化后的信号由芯片输出到外部。

说到无线电接收，"两比特 ADC "听起来有点不寻常，但您可以使用单比特 ADC 接收全球导航卫星系统信号！

在这种情况下，ADC 有两个输出 - SIGN 和 MAG（幅度）。第一个是模拟信号的符号，第二个是信号电平增加的符号。芯片还输出 ACQCLK 信号，在该信号的上升沿，数字数据接收器应从 ADC 捕捉数据。时钟信号的频率相当高 - ~38MHz。

该芯片还有一个 AGCDATA 增益控制输入端，在芯片组中与 GSP2e/LP 相连，用于分析来自 ADC 的数据并切换增益。由于我不打算断开 GSP2e，所以不需要考虑这根线。

示波器在 ACQCLK/SIGN 线路上显示了这些信号：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240310191528953.png" alt="image-20240310191528953" style="zoom:67%;" />

最重要的是，该 GPS 接收机可用于获取 "原始 "GPS 数据--只需从 SIGN/MAG 线路捕获数据并将其传输到 PC，然后在 GNSS-SDRLIB 中进行处理即可。老实说，我以为这不会花很长时间，但我错了....。

## 四、从 GPS 射频前端接收数字信号

如上所述，GRF2i/LP 芯片有两条数据线和一条时钟线。然而，简单地将这些线路连接到一些普通的数字逻辑上是行不通的--所有三条线路都是 PECL（伪发射极耦合逻辑）类型，信号摆幅很小（约 700mV），并且存在一个约 1.5V 的恒定分量。芯片有一个特殊的输出 PECLREF，其偏移电压就是这个值。因此，要获得通常 CMOS 3.3V 类型的数字数据，我们需要三个比较器，而且是快速比较器（请注意，数据传输速率为 38 MSPS）。

为了转换信号，我制作了一块特殊的电路板，上面安装了正交比较器 MAX964EEE+ 芯片。

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240310191727741.png" alt="image-20240310191727741" style="zoom:67%;" />

焊盘 P1、P2、P4 与接收器的 ACQCLK/SIGN/MAG 线路相连，焊盘 P9、P10、P11 为输出端。电路板上有两个用于测试的 U.FL 连接器，使用它们可以将电路板直接连接到示波器上。示波器显示以下信号：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240310191810591.png" alt="image-20240310191810591" style="zoom:80%;" />

可以看出，信号具有陡峭的前沿和适当的振幅。

最终的结构看起来是这样的：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240310191846403.png" alt="image-20240310191846403" style="zoom:80%;" />

如您所见，比较器电路板是用细线与 GRF2i 线路连接的。这种连接不会影响接收器的运行--您仍然可以通过蓝牙连接接收器，查看它正在接收哪些卫星。接收器内部有一个内置的有源天线，我把它拆开，用一根长导线焊接了一个较大天线的连接器。比较器电路板由外部供电。

## 五、将数字中频数据传输到个人电脑

如上文所述，采样率为 38 MSPS，相当于 76 Mbit/s 的数据流量。这是一个相当大的数字，因此我决定使用一个专用芯片 cy7c68013a 进行数据传输，它可以在 "USB-并行总线 "转换模式下工作。这种芯片是可编程的，也许可以配置为通过两比特总线接收数据，但我决定使用现成的软件和八比特总线。

如果尝试将两比特总线转换为八比特总线，将给 USB 和 PC 带来巨大负担--产生的数据流将达到 304 Mbit/s，我甚至不确定 USB HS 是否能处理它。那么，如何将两位数据流转换为八位数据流呢？你可以使用移位寄存器芯片和触发器制作一个转换器，但我采用了更简单的方法，使用 DE0-Nano FPGA 调试板。由于任务非常简单，Verilog 代码也很简单。结果，FPGA 在 ACQCLK 的 4 个时钟周期内产生一个字节的数据（8 个输出）。四个高位为 SIGN，四个低位为 MAG。还有一个同步输出。这样，我们就得到了 9.5 Mbyte/s 的数据流。

我有一块廉价的 CY7C68013a 芯片调试板，打算用它来捕获 FPGA 的数据：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240310192044739.png" alt="image-20240310192044739" style="zoom: 80%;" />

> 这个板子在淘宝上20块就可以买到，相关的项目有一个逻辑分析仪。

当我计划用它来捕获数据时，我希望使用开源项目 sigrok - 他们有使用这种电路板创建逻辑信号分析仪的例子。然而，事实证明，sigrok 固件不支持外部时钟。

接下来，我找到了 Linux 下的 [fx2pipe](https://www.triplespark.net/elec/periph/USB-FX2/software/fx2pipe.html) 项目。该项目承诺能通过外部时钟从并行总线上捕获数据，但它基于 libusb-0.1，非常老旧，很难在现代 Linux 上运行。

后来，我找到了这个项目的现代修改版：[Cannelloni](https://github.com/jhol/cannelloni)（[小讨论](https://www.eevblog.com/forum/programming/updating-fx2pipe-to-work-with-libusb-1-0/)）。像往常一样，这是典型的 Linux - 你必须自己构建一切（包括 CY7C68013a 固件），说明不完整....。最后，我设法构建了该项目，但并没有成功。

再搜索一下--在 fx2pipe 项目网站的深处有一处提及：

> 在运行该固件之前，您需要手动进行以下接线：
> 连接至高电平 (3.3V)： PA2/SLOE、PA5/FIFOADR1、RDY0/SLRD
> 连接至低电平（GND）： PA4/FIFOADR0、RY1/SLWR

在腔体上连接了很多连接线，但无济于事，PC 程序不接受任何数据。虽然可以看到 PC 程序成功地将固件加载到芯片中，但使用命令行按键还是可以从芯片 "内部 "开始捕获时钟数据。该调试板上的 sigrok 固件运行正常。

我花了很多时间处理这个问题，最后决定订购一块新的调试板，以防芯片的 IFCLK 输入端损坏。新的调试板没有任何变化，与前一块调试板的性能完全相同，只是上面的芯片在外观上与第一块调试板略有不同，温度也低了许多。在这里，我已经有了一种感觉--"也许这两个芯片都是假的"。

我记得我有一块未完成的调试板，上面有相同的芯片 CY7C68013-128A。我从一个不需要的电视调谐器上焊下了这个芯片，很明显它还在工作。我再次花了很多时间来恢复这块电路板（它是用 LUT 技术制作的，有些轨道被蚀刻了），焊接了一定数量的跳线，这些跳线是 fx2pipe 所必需的（有些跳线必须直接焊接到芯片的脚），最后，数据捕获成功了！显然，中国芯片出了问题。

如果有人觉得有用，这里有一个使用 cannelloni 捕捉 81920 个样本的命令示例：

```
./cannelloni -f fx2pipe.ihx -t fx2lp -i -8 -b 8192 -n 81920 -c x -v > test.bin
```

为了以防万一，我注意到应用于 IFCLK 输入的信号时钟频率应大于 5 MHz，而且信号应在 PC 开始向芯片加载固件之前开始应用。

最终的结果就是这个奇怪的小设计：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240310192359655.png" alt="image-20240310192359655" style="zoom: 33%;" />

我想，读者马上就会有一个疑问--为什么会有指针式毫安表（1957 年版）？如上文所述，起初由于电路板质量差，CY7C68013A 电路板不稳定。通过电流表可以监测电路板消耗的电流，从而确定芯片的工作模式。当电路板工作稳定时，你可以区分不同的状态--固件未加载/已加载/数据传输开始。为 CY7C68013A 供电需要直流-直流转换器电路板（电流表下方）。电流相当大，线性转换器无法满足要求。可以看到 CY7C68013A 电路板上没有安装 EEPROM。对于 cannelloni 来说，这是不需要的，因为软件本身会在启动时将固件加载到芯片中。

## 六、处理采集的信号

因此，我能够使用 cannelloni 程序将大量数据采集到 PC 上的文件中。GNSS-SDRLIB 程序能够处理文件中的数据。因此，通过文件转换器，我可以在 GNSS-SDRLIB 中分析数据。遗憾的是，GNSS-SDRLIB 支持的文件格式在任何地方都没有很好的描述（说实话，这个程序的文档很差）。因此，在深入研究源代码后，我发现 [GN3Sv3](https://www.sparkfun.com/products/retired/10981) 接收机格式是最好的。格式非常简单--它是 int8_t 类型 ADC 的连续结果，该接收器也使用 2 位 ADC，因此可接受的数据值为 [-3,-1,1,3]。

我快速编写了一个将文件转换为 GN3Sv3 格式的 C# 转换器，记录了 40 秒的数据，并在 GNSS-SDRLIB GUI 中指定了接收器的特性（"采样频率" - ADC 采样频率、ACQCLK 和 "中间频率"）。- 中间频率，我在上面也提到过）。但是没有任何效果，....

结果无法捕捉到卫星信号。

我想指出的是，程序有一个显示输入数据直方图和信号频谱的选项。就我的数据而言，它们看起来非常合适：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240310192624750.png" alt="image-20240310192624750" style="zoom: 80%;" />

什么是信号采集？
如上所述，GPS 信号的基础是长度为 1023 比特的伪随机码。通过计算接收到的信号与接收器产生的信号之间的相互相关性，就可以在接收到的信号中检测到这一代码。在这种情况下，我们必须有以下未知数：

* 卫星编号。这是生成 PRN 代码所必需的。在 "冷启动 "时，接收机对卫星轨道、其坐标和时间一无所知，因此接收机需要搜索卫星编号，检查信号是否存在，或者（如果接收机有必要的硬件资源）--并行分析所有现有编号。在 GNSS-SDRLIB 程序中，卫星编号由用户选择。
* 寻找数据流的信号频率。卫星在天空中不断移动，因此地球上接收到的信号会产生多普勒频移。在 "冷启动 "状态下，接收机对卫星也是一无所知，因此只能通过蛮力来确定真实频率。显然，我们接收到的每颗卫星信号的频率都是不同的。通常搜索范围在 ±10 kHz 之间。
* 信号相位。事实上，它是接收数据中一个 PRN 码周期的位置。正是不同卫星信号之间的相位差被用来计算它们之间的距离。

正如您所看到的，即使知道卫星编号，也需要进行大量计算才能检测到来自卫星的信号--您必须浏览所有 1023 个相位变量和几十个频率，每次都要计算相关性。如果接收器有硬件相关器，这项工作不会花费太长时间，但在个人电脑上计算速度会相当慢。就 GNSS-SDRLIB 而言，程序作者使用了 FFT 搜索方法，即把数据从时域转移到频域。

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240310192801962.png" alt="image-20240310192801962" style="zoom: 67%;" />

"本地振荡器"--产生一个移频 X 赫兹的中频（IF）信号（该值在搜索过程中已列 出）。将输入数据与该振荡器产生的数据相乘，就能得到移频为零的复数形式的数据。然后，接收器使用 FFT 将数据传输到频域，即计算输入信号在分析频率上的频谱。

"PRN 代码生成器 "计算给定卫星的 PRN 数据，并对其进行 FFT 变换，然后计算出找到的值的复共轭值。请注意，由于 PRN 仅取决于卫星编号，这部分操作只需在启动接收机时执行一次。这样，我们就得到了 PRN 码的频谱。

然后将两个频谱逐元素相乘，并计算所得到数据的反傅里叶变换 (IFFT)，即把数据转回时域。

为什么要做上述所有工作？[卷积定理](https://en.wikipedia.org/wiki/Convolution_theorem)指出，时域卷积等同于频域乘法。因此，通过上述运算，我们可以得到 PRN 码相位每个变体的相关值。通过分析得出的数组中哪个位置的相关值超过了某个临界值，我们就得到了相位值。如果没有，则表示该频率上没有来自该卫星的信号。

GNSS-SDRLIB 可以生成这样的采集结果可视化图：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240310192942715.png" alt="image-20240310192942715" style="zoom: 67%;" />

图片显示的是上述 N 次计算的结果，针对的是单颗卫星的 N 个过采样频率。偏移只是采样中的相位，但这里的频率符号不正确，实际值不是赫兹，只是 N 个采样频率中的一个索引值。在软件中，捕捉算法位于 sdracq.c 文件中。我花了很长时间才弄清数据出了什么问题，在调试器中一切看起来都很正常。唯一剩下的问题是程序中的频率设置不正确。

上述介绍中提到的频率为 ACQCLK=38.192 MHz 和 IF=9.548 MHz（1/4 ACQCLK）。书[1]中也提到了同样的频率。

但应用说明 APNT0012 提到了其他频率：ACQCLK=38.194 和 IF=9.45MHz。但是，如果我们分析结构图，就能确定连接射频前端芯片所有频率的分频系数和公式。根据它们，第一个频率符合，第二个频率不符合。但是，我们明显感觉到这里出了问题。

要计算真实频率值，我只需要知道接收机所用石英振荡器的 TCXO 频率。这就有一个问题--在互联网上找不到 R2141 Y439 的标记，我也没有精确的频率计（后来我发现它可以是 Rakon 零件 2141-24.5535MHZ）。通过在互联网上搜索，我找到了一个使用相同芯片组的 GPS 接收机的原理图，并发现其他制造商在使用该芯片组时也使用了 24.5535MHz 的 TCXO。

如果我们使用上述公式计算频率，就会得到不舒服的分数值：ACQCLK=38.19433(3) MHz，IF=9.452333(3) MHz。ACQCLK/IF 比率也变成了一个健康的分数。但这些数字与 APNT0012 中的数字相似，只是可能被四舍五入了。有了新的频率值，程序就能从捕获的数据中检测到卫星信号，这已经是很大的进步了。但是没有接收到数据，这又是一个问题....。

现在的问题与卫星数据的跟踪（追踪）有关。什么是跟踪？一旦捕捉到信号，接收机就不再需要搜索卫星信号的频率，也不需要经历大量可能的 PRN 相位--它已经确定了这些值。不过，频率是在捕获过程中大致确定的，而且会随着卫星在天空中的移动而变化。接收器中的 PRN 码生成率和相位也必须进行调整。

接收数据的来源与相关结果相同，只是现在相关计算的次数要少得多。这里使用的是常见的方法（早期、提示、晚期），即将接收到的数据与生成的 PRN 流进行比较，PRN 流经过 (-1/2;0;+1/2) 芯片移位。小数值从何而来？ADC 的采样频率远高于数据的 PRN 频率。通过比较相关结果，可以评估跟踪状态。

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240310193500697.png" alt="image-20240310193500697" style="zoom:67%;" />

由此产生的跟踪算法是这样的：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240310193530364.png" alt="image-20240310193530364" style="zoom:50%;" />

在这种情况下，"NCO 载波发生器 "是一个软件中间频率发生器，其频率由 PLL（锁相环）算法调整。"E-P-L" - 相关器，"PRN 码发生器" - PRN 码发生器。DLL（延迟锁定环）算法控制着代码生成的速度。相关器的结果经整合后用于判别器，以确定校正系数。判别器由相当简单的数学表达式描述。

请注意，跟踪算法以一个 PRN 码周期为块分析输入数据，即上述所有操作均应在 1 毫秒内完成，并适用于所有被分析的卫星。跟踪结果（当前相关结果）用于导航数据提取。

GNSS-SDRLIB 软件可以图表形式输出每颗卫星的相关器结果：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240310193626660.png" alt="image-20240310193626660" style="zoom:67%;" />

方案说明[2]指出，它为研究目的实现了更多的相关器，只有三对相关器用于跟踪目的。相关器的数量和它们之间的步长可以在图形用户界面中进行配置。但在我的案例中，在这些图表中，这只是噪音。

GNSS-SDRLIB 还可以保存跟踪日志。其中有大量数据，包括相关结果、计算修正值。通过绘制 IP 列，您可以看到导航数据的字节数：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240310193738808.png" alt="image-20240310193738808" style="zoom:67%;" />

从图中可以清楚地看到，跟踪算法的反馈从采集过程中发现的粗略值变为真实值的过程。

在我的案例中，同样的图表显示在短时间内有跟踪，但随后就 "中断 "了：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240310193807808.png" alt="image-20240310193807808" style="zoom:67%;" />

我花了很长时间才找出问题所在，最后发现这与 cannelloni 中的中间缓冲区太小有关。很明显，有时记录的数据会出现间隙，从而导致跟踪失败（因为同步被破坏了）。最后，我停止了缓冲区的大小 - 131072 字节。请注意，将天线与接收器断开几秒钟并不会导致跟踪失败。

## 七、进一步的实验

到了这个阶段，我已经有了一个能够充分分析写入文件的数据的软件。在这种模式下使用程序很不方便（数据占用大量空间），因此我在 GNSS-SDRLIB 中添加了对接收器的支持，即实时接收接收器的数据。因为我已经有了 cannelloni 的源代码，所以这并不难。

然而，事实证明，38 MSPS 的数据速率对于 GNSS-SDRLIB 来说太高了，因此我不得不在 FPGA 中将输入时钟信号除以二。

结果，数据接收如期进行，但定期（每分钟一次或更少）丢失轨迹簿，而且是同时丢失所有卫星的轨迹簿。

为了测试这一点，我在 FPGA 软件中添加了一些小的字节标记序列，每传输 10,000 个字节，就生成一次欺骗 ADC 数据的序列。在 PC 上分析数据时很容易发现这些序列，但从处理软件的角度来看，它们只是微弱的噪声。结果，还是会定期丢失数据，从而破坏同步。我找不到发生这种情况的原因，因此我只是在 GNSS-SDRLIB 中改进了数据分析--由于有了标记，您可以检测数据丢失并防止同步丢失。

这样，我就得到了一个 PC 程序，它可以分析 GPS 接收机接收到的 "原始 "数据，确定从每个卫星接收到的信号的相位，并从数据流中提取导航信息。GNSS-SDRLIB 接收到的所有数据都可以通过 TCP 的 RTCM 协议传输到更高级别的软件中进行进一步分析。正是这种高级软件计算接收器的坐标。RTKLIB 就是此类软件的一个例子。

使用我的接收机，我成功运行了 [RTKLIB](https://www.rtklib.com/)：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240310194521504.png" alt="image-20240310194521504" style="zoom:67%;" />

老实说，坐标测定的质量太差了，从上图可以看出，几分钟内坐标值的散射高达 ±20m，而这还是在使用了 6 颗卫星的情况下。为便于比较，使用 u-blox M8T 接收机（其原始数据也在 RTKLIB 中进行了处理）获得的坐标分布：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240310194553194.png" alt="image-20240310194553194" style="zoom:50%;" />

这里的坐标偏差约为±5 米，而且是在使用 5 颗卫星的情况下。使用的天线相同。

我还注意到，GNSS-SDRLIB 计划显然需要高水平的接收信号才能成功采集。例如，GNSS-SDRLIB 仅能充分捕获 4 颗卫星的信号，而 BT-318 接收器（其 GSP2e 芯片）却能同时捕获 6 颗卫星的数据。

在所有实验中，我都使用了安装在窗台上的有源天线。这导致只能接收到部分天空的信号，因此并不总能拨入信号强度较高的 GNSS-SDRLIB 6 卫星。

此外，在另一项实验中，我还制作了一块带有 GNSS 射频前端 MAX2769 的小型电路板：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240310194642493.png" alt="image-20240310194642493" style="zoom: 80%;" />

这种芯片之所以方便，是因为它有一种特殊模式--预配置设备状态，只要在 PGM 输入端输入 1，就能切换到这种模式。这样，无需通过 SPI 配置，就能从芯片获取数据。

我连接了这块板而不是 BT-318，禁用了 FPGA 中的 2 分频，更改了 GNSS-SDRLIB 中的频率设置，结果设计成功了。根据我的感觉，MAX2769 的灵敏度明显优于 GRF2i（尽管 MAX2769 也不年轻了 - 2007 年）。坐标测定的精确度也差不多。

在 GNSS-SDRLIB 中声明支持伽利略卫星（它们以与 GPS 相同的频率发射信号），但我不得不对程序稍作修改，使其能够开始处理和发送伽利略数据，但由于某些原因，来自伽利略卫星的正常信号只能在 RTKLIB 2.4.2 p13 中处理。

在实验过程中，我对 GNSS-SDRLIB 进行了许多不同的修改，结果发布在这里： https://github.com/iliasam/GNSS-SDRLIB。

## 相关链接

1. 一本关于构建全球导航卫星系统软件接收器的书籍：[《软件定义的 GPS 和伽利略接收器：单频方法》](https://www.ocf.berkeley.edu/~marsy/resources/gnss/A%20Software-Defined%20GPS%20and%20Galileo%20Receiver.pdf)（A Software-Defined GPS and Galileo Receiver: A Single-Frequency Approach）
2. GNSS-SDRLIB：[开放源码和实时 GNSS 软件定义无线电库](http://www.taroz.net/paper/IONGNSS2014_SDR.pdf)，也有[专题](http://www.taroz.net/paper/IONGNSS2014_SDR_ppt.pdf)介绍
3. 关于 C/A 代码的工作原理：[使用 MATLAB 和 C/C++ 生成 GPS L1 C/A 伪随机噪声 (PRN) 代码](https://www.wasyresearch.com/generating-gps-l1-c-a-pseudo-random-noise-prn-code-with-matlab-and-c-c/)
4. 90 年代非常酷的 GPS 接收机项目，采用模拟芯片、普通数字芯片和 MC68010 作为 CPU：[GPS 和 GLONASS 卫星的自制接收机](https://lea.hamradio.si/~s53mv/navsats/theory.html)。这里还详细介绍了全球导航卫星系统的理论。
5. 在 FPGA 上自制 GPS 接收机项目，理论描述也很详细： [自制 GPS 接收机](http://www.aholme.co.uk/GPS/Main.htm)